// ============================================================================
// DATABASE SCHEMA (Prisma Schema)
// File: prisma/schema.prisma
// ============================================================================

/*
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Worker {
  id                     String              @id @default(uuid())
  name                   String
  company                String?
  manager_name           String
  date_of_injury         DateTime
  expected_recovery_date DateTime?
  status_off_work        Boolean             @default(false)
  rtw_plan_present       Boolean             @default(false)
  created_at             DateTime            @default(now())
  updated_at             DateTime            @updatedAt
  
  cases                  Case[]
  worker_info_sheet      WorkerInfoSheet?
}

model Case {
  id                String         @id @default(uuid())
  worker_id         String
  risk_level        String
  current_status    String
  next_steps        Json           @default("[]")
  escalation_level  Int            @default(0)
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  
  worker            Worker         @relation(fields: [worker_id], references: [id])
  attachments       Attachment[]
  notes             CaseNote[]
  feedback          CaseFeedback[]
}

model Attachment {
  id         String   @id @default(uuid())
  case_id    String
  type       String
  filename   String
  url        String
  created_at DateTime @default(now())
  
  case       Case     @relation(fields: [case_id], references: [id])
}

model CaseNote {
  id                String   @id @default(uuid())
  case_id           String
  author            String
  body              String
  freshdesk_note_id String?
  created_at        DateTime @default(now())
  
  case              Case     @relation(fields: [case_id], references: [id])
}

model WorkerInfoSheet {
  id           String    @id @default(uuid())
  worker_id    String    @unique
  requested_at DateTime
  returned_at  DateTime?
  status       String
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  
  worker       Worker    @relation(fields: [worker_id], references: [id])
}

enum FeedbackType {
  correct
  not_relevant
  better_action
}

model CaseFeedback {
  id                  String       @id @default(uuid())
  case_id             String
  suggestion_text     String
  feedback_type       FeedbackType
  better_action_text  String?
  features            Json
  created_at          DateTime     @default(now())
  
  case                Case         @relation(fields: [case_id], references: [id])
}

model ModelTrainingRun {
  id                  String   @id @default(uuid())
  started_at          DateTime
  finished_at         DateTime?
  version             String
  metrics             Json
  shap_top_features   Json?
  created_at          DateTime @default(now())
}
*/

// ============================================================================
// DATABASE MIGRATIONS
// File: migrations/001_initial_schema.sql
// ============================================================================

/*
CREATE TABLE workers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  company VARCHAR(255),
  manager_name VARCHAR(255) NOT NULL,
  date_of_injury TIMESTAMP NOT NULL,
  expected_recovery_date TIMESTAMP,
  status_off_work BOOLEAN DEFAULT FALSE,
  rtw_plan_present BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  worker_id UUID NOT NULL REFERENCES workers(id) ON DELETE CASCADE,
  risk_level VARCHAR(50) NOT NULL,
  current_status TEXT NOT NULL,
  next_steps JSONB DEFAULT '[]',
  escalation_level INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID NOT NULL REFERENCES cases(id) ON DELETE CASCADE,
  type VARCHAR(100) NOT NULL,
  filename VARCHAR(255) NOT NULL,
  url TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE case_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID NOT NULL REFERENCES cases(id) ON DELETE CASCADE,
  author VARCHAR(255) NOT NULL,
  body TEXT NOT NULL,
  freshdesk_note_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE worker_info_sheet (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  worker_id UUID UNIQUE NOT NULL REFERENCES workers(id) ON DELETE CASCADE,
  requested_at TIMESTAMP NOT NULL,
  returned_at TIMESTAMP,
  status VARCHAR(50) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TYPE feedback_type AS ENUM ('correct', 'not_relevant', 'better_action');

CREATE TABLE case_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID NOT NULL REFERENCES cases(id) ON DELETE CASCADE,
  suggestion_text TEXT NOT NULL,
  feedback_type feedback_type NOT NULL,
  better_action_text TEXT,
  features JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE model_training_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  started_at TIMESTAMP NOT NULL,
  finished_at TIMESTAMP,
  version VARCHAR(100) NOT NULL,
  metrics JSONB NOT NULL,
  shap_top_features JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_cases_worker ON cases(worker_id);
CREATE INDEX idx_attachments_case ON attachments(case_id);
CREATE INDEX idx_notes_case ON case_notes(case_id);
CREATE INDEX idx_feedback_case ON case_feedback(case_id);
*/

// ============================================================================
// RULE ENGINE
// File: src/rules/engine.ts
// ============================================================================

interface Worker {
  status_off_work: boolean;
  rtw_plan_present: boolean;
  date_of_injury: Date;
}

interface Case {
  id: string;
  worker_id: string;
  escalation_level: number;
}

interface Message {
  from: string;
  body: string;
  created_at: Date;
}

export function deriveRisk(worker: Worker): string {
  // Rule: If worker is off work OR there is no current RTW plan, Risk Level must be High
  if (worker.status_off_work || !worker.rtw_plan_present) {
    return 'High';
  }
  
  // Calculate based on time since injury
  const daysSinceInjury = Math.floor(
    (Date.now() - worker.date_of_injury.getTime()) / (1000 * 60 * 60 * 24)
  );
  
  if (daysSinceInjury > 90) {
    return 'High';
  } else if (daysSinceInjury > 30) {
    return 'Medium';
  }
  
  return 'Normal';
}

export function deriveCurrentStatus(messages: Message[]): string {
  if (!messages || messages.length === 0) {
    return 'No recent activity';
  }
  
  // Take last 3-10 messages and summarize
  const recentMessages = messages.slice(-10);
  
  // Extract key information
  const keyPhrases: string[] = [];
  const keywords = [
    'claim', 'submitted', 'awaiting', 'seeking', 'suitable duties',
    'medical certificate', 'injury check', 'completed', 'forwarded',
    'requested', 'determination', 'assessment', 'recovery', 'RTW'
  ];
  
  recentMessages.forEach(msg => {
    const body = msg.body.toLowerCase();
    keywords.forEach(keyword => {
      if (body.includes(keyword.toLowerCase())) {
        const sentences = msg.body.split(/[.!?]+/);
        const relevantSentence = sentences.find(s => 
          s.toLowerCase().includes(keyword.toLowerCase())
        );
        if (relevantSentence && !keyPhrases.includes(relevantSentence.trim())) {
          keyPhrases.push(relevantSentence.trim());
        }
      }
    });
  });
  
  // Construct summary
  if (keyPhrases.length === 0) {
    return `Last contact: ${recentMessages[recentMessages.length - 1].created_at.toLocaleDateString()}`;
  }
  
  return keyPhrases.slice(0, 3).join('. ') + '.';
}

export function deriveNextSteps(
  caseData: Case,
  worker: Worker,
  currentStatus: string,
  messages: Message[],
  workerInfoSheet?: { requested_at: Date; returned_at?: Date; status: string }
): Array<{ text: string; priority: number; source: string }> {
  const steps: Array<{ text: string; priority: number; source: string }> = [];
  
  // Rule: Check worker info sheet escalation
  if (workerInfoSheet && !workerInfoSheet.returned_at) {
    const daysSinceRequest = Math.floor(
      (Date.now() - workerInfoSheet.requested_at.getTime()) / (1000 * 60 * 60 * 24)
    );
    
    if (daysSinceRequest >= 14) {
      const escalationContacts = ['Zora', 'Wayne', 'Michelle'];
      const level = Math.min(caseData.escalation_level, escalationContacts.length - 1);
      steps.push({
        text: `Escalate Worker Information Sheet request to ${escalationContacts[level]}`,
        priority: 1,
        source: 'rule'
      });
    } else if (daysSinceRequest >= 10) {
      steps.push({
        text: 'Follow up on Worker Information Sheet - due soon',
        priority: 2,
        source: 'rule'
      });
    }
  }
  
  // Rule: Off work without RTW plan
  if (worker.status_off_work && !worker.rtw_plan_present) {
    steps.push({
      text: 'Develop Return to Work plan with worker and manager',
      priority: 1,
      source: 'rule'
    });
  }
  
  // Rule: Off work with RTW plan
  if (worker.status_off_work && worker.rtw_plan_present) {
    steps.push({
      text: 'Review and update Return to Work plan progress',
      priority: 2,
      source: 'rule'
    });
  }
  
  // Rule: Check for stale communications
  if (messages.length > 0) {
    const lastMessage = messages[messages.length - 1];
    const daysSinceLastContact = Math.floor(
      (Date.now() - lastMessage.created_at.getTime()) / (1000 * 60 * 60 * 24)
    );
    
    if (daysSinceLastContact >= 7) {
      steps.push({
        text: 'Follow up - no contact for 7+ days',
        priority: 3,
        source: 'rule'
      });
    }
  }
  
  // Rule: Awaiting determination
  if (currentStatus.toLowerCase().includes('awaiting determination')) {
    steps.push({
      text: 'Check claim status with insurer',
      priority: 2,
      source: 'rule'
    });
  }
  
  // Rule: Seeking suitable duties
  if (currentStatus.toLowerCase().includes('seeking suitable duties')) {
    steps.push({
      text: 'Follow up on alternative duty options with manager',
      priority: 1,
      source: 'rule'
    });
  }
  
  // Sort by priority
  steps.sort((a, b) => a.priority - b.priority);
  
  return steps;
}

// ============================================================================
// FRESHDESK CLIENT
// File: src/integrations/freshdesk.ts
// ============================================================================

import axios from 'axios';

export class FreshdeskClient {
  private baseURL: string;
  private apiKey: string;
  private productId: string;
  
  constructor() {
    this.baseURL = process.env.FRESHDESK_BASE_URL || '';
    this.apiKey = process.env.FRESHDESK_API_KEY || '';
    this.productId = process.env.FRESHDESK_PRODUCT_ID || '';
  }
  
  private getHeaders() {
    return {
      'Authorization': `Basic ${Buffer.from(`${this.apiKey}:X`).toString('base64')}`,
      'Content-Type': 'application/json'
    };
  }
  
  async createPrivateNote(ticketId: string
Got it ✅ — here’s the full master document with everything expanded: the spec, guardrails, testing, QA, and the complete Prompt Library (Section 12). This is your one-stop copy-paste for Roylett / Agent 3.

⸻

Change Request: CR-GPNet-LLM-001

Title: Integration of Large Language Model (LLM) Adapter Service into GPNet

⸻

1. Purpose

Add an LLM Adapter Service into GPNet so the system can:
	•	Automatically generate Injury, Prevention, New Starter, Exit, and Mental Health reports in GPNet templates.
	•	Power “Michelle”, a conversational assistant that adapts to worker responses.
	•	Provide compliant references to the Workplace Injury Rehabilitation & Compensation Act 2013 (ss104–116) and WorkSafe Claims Manual (5.1–5.1.6).

⸻

2. Scope

In scope
	•	LLM service layer with strict rules and guardrails.
	•	Report generation with disclaimers, Fit Classification, recommendations, and legislation refs.
	•	Conversational assistant (“Michelle”).
	•	Fit classifier converting free text to Fit / Fit with restrictions / Not fit.
	•	Legislation lookup resolving IDs to titles/links.
	•	Audit logging of every LLM call.
	•	Fallback skeleton if LLM unavailable.

Out of scope
	•	Hosting the model weights locally.
	•	Free-form queries outside GPNet workflows.

⸻

3. Architecture

[Frontend: Recruiter/HR/Worker] 
     ⬇
[Case Workflow Engine / Michelle Chatbot]
     ⬇
[LLM Adapter Service] ──→ [LLM API endpoint]
                         ↕
        [Templates + Legislation JSON + Prompts]

	•	Adapter enforces templates, JSON citations, and audit logging.
	•	Workflow engine decides when to call the LLM.

⸻

4. Functions

A. Report Generation
	•	Injury, Prevention, New Starter, Exit, Mental Health reports.
	•	Always: Disclaimer, Summary, Fit Classification, Recommendations, Sections, Appendix A.
	•	Fit defaults to “Fit without restriction” unless evidence suggests otherwise.
	•	Cite legislation IDs only (e.g., “WIRC s113”).

B. Conversational Assistant (Michelle)
	•	Asks one question at a time, adapts to answers.
	•	Extracts structured fields (symptoms, weights, risks).
	•	Flags psychosocial risks.
	•	Escalates if distress/self-harm mentioned.

C. Classifier
	•	Input: free text + hints.
	•	Output:
	•	fit_classification (Fit / Fit with restrictions / Not fit)
	•	risk_flags[]
	•	suggested_restrictions[]

D. Legislation Lookup
	•	Input: list of IDs.
	•	Output: titles + URLs from JSON file.
	•	No statute text, no invented IDs.

⸻

5. Guardrails
	•	Cite only IDs in rtw_legislation_combined.json.
	•	Always insert disclaimer verbatim.
	•	Log {templateId, refs, source_version, checksum}.
	•	If model fails → return skeleton with TODOs.

⸻

6. Deliverables
	•	Backend service: llmAdapter with /llm/report, /llm/chat, /llm/classify, /llm/lookup.
	•	Templates: 5 Markdown files in /knowledge/templates/.
	•	Legislation: rtw_legislation_combined.json.
	•	Chatbot UI: /apps/frontend/src/modules/michelle/.
	•	Audit log integration.

⸻

7. Acceptance Criteria
	•	Reports generated <5s, include disclaimer + Fit Classification.
	•	Chatbot always returns reply + 1–3 next questions.
	•	Classifier returns correct JSON output.
	•	Lookup resolves only JSON IDs.
	•	Audit log records all calls.
	•	Fallback skeleton works if API down.

⸻

8. Risks
	•	Dependency on external LLM API.
	•	Slightly longer build time.
	•	Risk of hallucinations (controlled with guardrails).

⸻

9. Example Behaviours
	•	Injury Check: cites s104/s111/s113, outputs restrictions.
	•	Prevention Check: Fit without restriction unless risk flagged.
	•	New Starter: flags onboarding supports.
	•	Exit: provides recruiter/employer insights.
	•	Mental Health: inserts URGENT FLAG if self-harm detected.
	•	Michelle Chat: “My hand hurts lifting boxes” → reply “How heavy are the boxes?”
	•	Classifier: “Wrist pain lifting 8kg repeatedly” → Fit with restrictions, ≤5kg limit.
	•	Lookup: IDs in → titles/links out.

⸻

10. Testing Module

Unit Tests
	•	Report generator produces all sections + disclaimer + valid refs.
	•	Chatbot always returns reply_text + next_questions.
	•	Classifier outputs valid JSON.
	•	Lookup resolves valid IDs, marks unresolved correctly.

Integration Tests
	•	End-to-end /llm/report, /llm/chat, /llm/classify, /llm/lookup.
	•	Case storage includes audit log.
	•	Fallback skeleton tested when API down.

Acceptance Tests
	•	HR sees professional, template-consistent reports with IDs.
	•	Worker experiences natural, supportive chat.
	•	Case manager sees complete audit trail.

Fixtures
	•	Data for all 5 report types, multiple variations.
	•	50+ conversation scripts for Michelle.
	•	Valid + invalid ID sets.

⸻

11. QA & Testing Requirements
	•	2000+ automated test cases across unit, integration, acceptance.
	•	≥95% coverage required.
	•	Must test: happy path, edge cases, failures, guardrails, escalation.
	•	All tests in CI/CD; block merges if guardrail tests fail.
	•	Test results exported (HTML/JSON).

⸻

12. Prompt Library – Full Expansion

12.1 Injury Check
	•	System: Generate Injury Check. Use template. Default Fit = Fit without restriction. Law = JSON IDs only. Insert disclaimer. Neutral tone.
	•	Sections: Disclaimer, Summary, Fit Classification, Recommendations, Health Overview, Physical Health, Emotional Wellbeing, Work/Social Impacts, Lifestyle, Support Provided, Outlook, Appendix A.
	•	Output: YAML with meta + body_markdown.

12.2 Prevention Check
	•	System: Generate Prevention Check. Same rules. Default Fit = Fit without restriction unless risk. Disclaimer required.
	•	Sections: Disclaimer, Summary (concerns, risks, perceived capacity), Fit Classification, Recommendations (preventive, ergonomic, wellbeing), Health Overview, Physical Health, Emotional Wellbeing, Work/Social Impacts, Lifestyle, Support Provided, Outlook, Appendix A.

12.3 New Starter Check
	•	System: Generate New Starter Check. Focus on onboarding + early risk flags.
	•	Sections: Disclaimer, Summary (role demands, perceived capacity, flags), Fit Classification, Recommendations (supports, rotation, micro-breaks, early physio), Health Overview, Work/Social Impacts, Outlook, Appendix A.

12.4 Exit Check
	•	System: Generate Exit Check. Summarise reasons for exit + recruiter/employer insights.
	•	Sections: Disclaimer, Summary (issues, reasons), Supports Provided, Insights for employer/recruiter, Outlook, Appendix A.

12.5 Mental Health Check
	•	System: Generate Mental Health Check. Insert URGENT FLAG if self-harm/acute risk. Supportive, non-diagnostic, “reported” phrasing.
	•	Sections: Disclaimer, Summary (concerns, stressors), Fit Classification, Recommendations (EAP, GP/psych, workload), Psychosocial Factors, Work/Social Impacts, Support Provided, Outlook, Appendix A.

12.6 Michelle Chat
	•	System: You are “Michelle.” One question at a time, adaptive, concise, supportive. Extract structured fields. Escalate if distress/self-harm. Cite IDs only if relevant.
	•	Output must include:
	•	reply_text
	•	next_questions[] (0–3)
	•	extracted_fields{}
	•	flags{risk[], compliance[], escalation}
	•	legislation_refs[]

12.7 Classifier (Fit & Risk)
	•	System: Classify worker status from text + hints. Conservative: pain + load + repetition = Fit with restrictions. JSON only.
	•	Output:
	•	fit_classification (Fit / Fit with restrictions / Not fit)
	•	risk_flags[]
	•	suggested_restrictions[]

12.8 Legislation Lookup
	•	System: Resolve ONLY IDs in rtw_legislation_combined.json. No inventing. Return title + URL only.
	•	Input: {ids:[...]}
	•	Output: {resolved:[], unresolved:[]}

⸻

✅ This is the master CR document — includes spec, guardrails, testing, QA, and full prompt library.

⸻

Do you want me to also generate this as a Word/PDF file so you can keep a clean copy outside of Replit as well?